(()=>{"use strict";const t="*&*",e="*",n="+",s="(",i=")",a=[n,s,i],o=[t,n],r=[e],l=[s,n,t,e],c=[i,n,t],h={KLEIN_OP:8,CONCAT_OP:4,OR_OP:2},d="\\epsilon";function u(t,e,n,s,i,a,o,r,l){return t*i*l+e*a*o+n*s*r-t*a*r-e*s*l-n*i*o}function f(t,e){return t.toFixed(e).replace(/0+$/,"").replace(/\.$/,"")}const g={cursorVisible:!0,selectedObject:null,currentLink:null,movingObject:!1,originalClick:null},p=[],x=[];let y;class m{constructor(){this._points=[],this._texData="",this._scale=.1,this.strokeStyle=void 0}toLaTeX(){return"\\documentclass[12pt]{article}\n\\usepackage{tikz}\n\n\\begin{document}\n\n\\begin{center}\n\\begin{tikzpicture}[scale=0.2]\n\\tikzstyle{every node}+=[inner sep=0pt]\n"+this._texData+"\\end{tikzpicture}\n\\end{center}\n\n\\end{document}\n"}beginPath(){this._points=[]}arc(t,e,n,s,i,a){if(t*=this._scale,e*=this._scale,n*=this._scale,i-s==2*Math.PI)this._texData+="\\draw ["+this.strokeStyle+"] ("+f(t,3)+","+f(-e,3)+") circle ("+f(n,3)+");\n";else{if(a){const t=s;s=i,i=t}i<s&&(i+=2*Math.PI),Math.min(s,i)<-2*Math.PI?(s+=2*Math.PI,i+=2*Math.PI):Math.max(s,i)>2*Math.PI&&(s-=2*Math.PI,i-=2*Math.PI),s=-s,i=-i,this._texData+="\\draw ["+this.strokeStyle+"] ("+f(t+n*Math.cos(s),3)+","+f(-e+n*Math.sin(s),3)+") arc ("+f(180*s/Math.PI,5)+":"+f(180*i/Math.PI,5)+":"+f(n,3)+");\n"}}moveTo(t,e){t*=this._scale,e*=this._scale,this._points.push({x:t,y:e})}lineTo(t,e){t*=this._scale,e*=this._scale,this._points.push({x:t,y:e})}stroke(){if(0!=this._points.length){this._texData+="\\draw ["+this.strokeStyle+"]";for(let t=0;t<this._points.length;t++){const e=this._points[t];this._texData+=(t>0?" --":"")+" ("+f(e.x,2)+","+f(-e.y,2)+")"}this._texData+=";\n"}}fill(){if(0!=this._points.length){this._texData+="\\fill ["+this.strokeStyle+"]";for(let t=0;t<this._points.length;t++){const e=this._points[t];this._texData+=(t>0?" --":"")+" ("+f(e.x,2)+","+f(-e.y,2)+")"}this._texData+=";\n"}}measureText(t){const e=y.getContext("2d");return e.font='20px "Times New Romain", serif',e.measureText(t)}advancedFillText(t,e,n,s,i){if(t.replace(" ","").length>0){let a="";if(null!=i){const e=this.measureText(t).width,o=Math.cos(i),r=Math.sin(i);Math.abs(o)>Math.abs(r)?o>0?(a="[right] ",n-=e/2):(a="[left] ",n+=e/2):r>0?(a="[below] ",s-=10):(a="[above] ",s+=10)}n*=this._scale,s*=this._scale,this._texData+="\\draw ("+f(n,2)+","+f(-s,2)+") node "+a+"{$"+e.replace(/ /g,"\\mbox{ }")+"$};\n"}}translate(){}save(){}restore(){}clearRect(){}}class A{constructor(){this.fillStyle="black",this.strokeStyle="black",this.lineWidth=1,this.font="12px Arial, sans-serif",this._points=[],this._svgData="",this._transX=0,this._transY=0}toSVG(){return'<?xml version="1.0" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n\n<svg width="800" height="600" version="1.1" xmlns="http://www.w3.org/2000/svg">\n'+this._svgData+"</svg>\n"}beginPath(){this._points=[]}arc(t,e,n,s,i,a){t+=this._transX,e+=this._transY;const o='stroke="'+this.strokeStyle+'" stroke-width="'+this.lineWidth+'" fill="none"';if(i-s==2*Math.PI)this._svgData+="\t<ellipse "+o+' cx="'+f(t,3)+'" cy="'+f(e,3)+'" rx="'+f(n,3)+'" ry="'+f(n,3)+'"/>\n';else{if(a){const t=s;s=i,i=t}i<s&&(i+=2*Math.PI);const r=t+n*Math.cos(s),l=e+n*Math.sin(s),c=t+n*Math.cos(i),h=e+n*Math.sin(i),d=Math.abs(i-s)>Math.PI,u=1;this._svgData+="\t<path "+o+' d="',this._svgData+="M "+f(r,3)+","+f(l,3)+" ",this._svgData+="A "+f(n,3)+","+f(n,3)+" ",this._svgData+="0 ",this._svgData+=+d+" ",this._svgData+=+u+" ",this._svgData+=f(c,3)+","+f(h,3),this._svgData+='"/>\n'}}moveTo(t,e){t+=this._transX,e+=this._transY,this._points.push({x:t,y:e})}lineTo(t,e){t+=this._transX,e+=this._transY,this._points.push({x:t,y:e})}stroke(){if(0!=this._points.length){this._svgData+='\t<polygon stroke="'+this.strokeStyle+'" stroke-width="'+this.lineWidth+'" points="';for(let t=0;t<this._points.length;t++)this._svgData+=(t>0?" ":"")+f(this._points[t].x,3)+","+f(this._points[t].y,3);this._svgData+='"/>\n'}}fill(){if(0!=this._points.length){this._svgData+='\t<polygon fill="'+this.fillStyle+'" stroke-width="'+this.lineWidth+'" points="';for(let t=0;t<this._points.length;t++)this._svgData+=(t>0?" ":"")+f(this._points[t].x,3)+","+f(this._points[t].y,3);this._svgData+='"/>\n'}}measureText(t){const e=y.getContext("2d");return e.font='20px "Times New Romain", serif',e.measureText(t)}fillText(t,e,n){e+=this._transX,n+=this._transY,t.replace(" ","").length>0&&(this._svgData+='\t<text x="'+f(e,3)+'" y="'+f(n,3)+'" font-family="Times New Roman" font-size="20">'+function(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let e="";for(let n=0;n<t.length;n++){let s=t.charCodeAt(n);e+=s>=32&&s<=126?t[n]:"&#"+s+";"}return e}(t)+"</text>\n")}translate(t,e){this._transX=t,this._transY=e}save(){}restore(){}clearRect(){}}class M{constructor(t,e){this.x=t,this.y=e,this.mouseOffsetX=0,this.mouseOffsetY=0,this.isAcceptState=!1,this.text=""}setMouseStart(t,e){this.mouseOffsetX=this.x-t,this.mouseOffsetY=this.y-e}setAnchorPoint(t,e){this.x=t+this.mouseOffsetX,this.y=e+this.mouseOffsetY}draw(t){t.beginPath(),t.arc(this.x,this.y,30,0,2*Math.PI,!1),t.stroke(),j(t,this.text,this.x,this.y,null,g.selectedObject==this),this.isAcceptState&&(t.beginPath(),t.arc(this.x,this.y,24,0,2*Math.PI,!1),t.stroke())}closestPointOnCircle(t,e){const n=t-this.x,s=e-this.y,i=Math.sqrt(n*n+s*s);return{x:this.x+30*n/i,y:this.y+30*s/i}}containsPoint(t,e){return(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)<900}}class b{constructor(t,e){this.node=t,this.anchorAngle=0,this.mouseOffsetAngle=0,this.text="",e&&this.setAnchorPoint(e.x,e.y)}setMouseStart(t,e){this.mouseOffsetAngle=this.anchorAngle-Math.atan2(e-this.node.y,t-this.node.x)}setAnchorPoint(t,e){this.anchorAngle=Math.atan2(e-this.node.y,t-this.node.x)+this.mouseOffsetAngle;const n=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);Math.abs(this.anchorAngle-n)<.1&&(this.anchorAngle=n),this.anchorAngle<-Math.PI&&(this.anchorAngle+=2*Math.PI),this.anchorAngle>Math.PI&&(this.anchorAngle-=2*Math.PI)}getEndPointsAndCircle(){const t=this.node.x+45*Math.cos(this.anchorAngle),e=this.node.y+45*Math.sin(this.anchorAngle),n=22.5,s=this.anchorAngle-.8*Math.PI,i=this.anchorAngle+.8*Math.PI;return{hasCircle:!0,startX:t+n*Math.cos(s),startY:e+n*Math.sin(s),endX:t+n*Math.cos(i),endY:e+n*Math.sin(i),startAngle:s,endAngle:i,circleX:t,circleY:e,circleRadius:n}}draw(t){const e=this.getEndPointsAndCircle();t.beginPath(),t.arc(e.circleX,e.circleY,e.circleRadius,e.startAngle,e.endAngle,!1),t.stroke();const n=e.circleX+e.circleRadius*Math.cos(this.anchorAngle),s=e.circleY+e.circleRadius*Math.sin(this.anchorAngle);j(t,this.text,n,s,this.anchorAngle,g.selectedObject==this),O(t,e.endX,e.endY,e.endAngle+.4*Math.PI)}containsPoint(t,e){const n=this.getEndPointsAndCircle(),s=t-n.circleX,i=e-n.circleY,a=Math.sqrt(s*s+i*i)-n.circleRadius;return Math.abs(a)<6}}class _{constructor(t,e){this.node=t,this.deltaX=0,this.deltaY=0,this.text="",e&&this.setAnchorPoint(e.x,e.y)}setAnchorPoint(t,e){this.deltaX=t-this.node.x,this.deltaY=e-this.node.y,Math.abs(this.deltaX)<6&&(this.deltaX=0),Math.abs(this.deltaY)<6&&(this.deltaY=0)}getStartPoint(){return{x:this.node.x+this.deltaX,y:this.node.y+this.deltaY}}getEndPoints(){const t=this.node.x+this.deltaX,e=this.node.y+this.deltaY,n=this.node.closestPointOnCircle(t,e);return{startX:t,startY:e,endX:n.x,endY:n.y}}draw(t){const e=this.getEndPoints();t.beginPath(),t.moveTo(e.startX,e.startY),t.lineTo(e.endX,e.endY),t.stroke();const n=Math.atan2(e.startY-e.endY,e.startX-e.endX);j(t,this.text,e.startX,e.startY,n,g.selectedObject==this),O(t,e.endX,e.endY,Math.atan2(-this.deltaY,-this.deltaX))}containsPoint(t,e){const n=this.getEndPoints(),s=n.endX-n.startX,i=n.endY-n.startY,a=Math.sqrt(s*s+i*i),o=(s*(t-n.startX)+i*(e-n.startY))/(a*a),r=(s*(e-n.startY)-i*(t-n.startX))/a;return o>0&&o<1&&Math.abs(r)<6}}const P=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"];function w(t){for(let e=0;e<P.length;e++){const n=P[e];t=(t=t.replace(new RegExp("\\\\"+n,"g"),String.fromCharCode(913+e+ +(e>16)))).replace(new RegExp("\\\\"+n.toLowerCase(),"g"),String.fromCharCode(945+e+ +(e>16)))}for(let e=0;e<10;e++)t=t.replace(new RegExp("_"+e,"g"),String.fromCharCode(8320+e));return t}function O(t,e,n,s){const i=Math.cos(s),a=Math.sin(s);t.beginPath(),t.moveTo(e,n),t.lineTo(e-8*i+5*a,n-8*a-5*i),t.lineTo(e-8*i-5*a,n-8*a+5*i),t.fill()}function v(){return(document.activeElement||document.body)==document.body}function j(t,e,n,s,i,a){const o=w(e);t.font='20px "Times New Roman", serif';const r=t.measureText(o).width;if(n-=r/2,null!=i){const t=Math.cos(i),e=Math.sin(i),a=(r/2+5)*(t>0?1:-1),o=15*(e>0?1:-1),l=e*Math.pow(Math.abs(e),40)*a-t*Math.pow(Math.abs(t),10)*o;n+=a-e*l,s+=o+t*l}"advancedFillText"in t?t.advancedFillText(o,e,n+r/2,s,i):(n=Math.round(n),s=Math.round(s),t.fillText(o,n,s+6),a&&S&&v()&&document.hasFocus()&&(n+=r,t.beginPath(),t.moveTo(n,s-10),t.lineTo(n,s+10),t.stroke()))}let k,S=!0;function X(){clearInterval(k),k=setInterval((function(){S=!S,T()}),500),S=!0}function Y(t){t.clearRect(0,0,y.width,y.height),t.save(),t.translate(.5,.5);for(let e=0;e<p.length;e++)t.lineWidth=1,t.fillStyle=t.strokeStyle=p[e]==g.selectedObject?"blue":"black",p[e].draw(t);for(let e=0;e<x.length;e++)t.lineWidth=1,t.fillStyle=t.strokeStyle=x[e]==g.selectedObject?"blue":"black",x[e].draw(t);null!=g.currentLink&&(t.lineWidth=1,t.fillStyle=t.strokeStyle="black",g.currentLink.draw(t)),t.restore()}function T(){Y(y.getContext("2d")),function(){if(!localStorage||!JSON)return;const t={nodes:[],links:[]};for(let e=0;e<p.length;e++){const n=p[e];let s={x:n.x,y:n.y,text:n.text,isAcceptState:n.isAcceptState};t.nodes.push(s)}for(let e=0;e<x.length;e++){const n=x[e];let s=null;n instanceof b?s={type:"SelfLink",node:p.indexOf(n.node),text:n.text,anchorAngle:n.anchorAngle}:n instanceof _?s={type:"StartLink",node:p.indexOf(n.node),text:n.text,deltaX:n.deltaX,deltaY:n.deltaY}:n instanceof $&&(s={type:"Link",nodeA:p.indexOf(n.nodeA),nodeB:p.indexOf(n.nodeB),text:n.text,lineAngleAdjust:n.lineAngleAdjust,parallelPart:n.parallelPart,perpendicularPart:n.perpendicularPart}),null!=s&&t.links.push(s)}localStorage.fsm=JSON.stringify(t)}()}function C(t,e){for(let n=0;n<p.length;n++)if(p[n].containsPoint(t,e))return p[n];for(let n=0;n<x.length;n++)if(x[n].containsPoint(t,e))return x[n];return null}function I(t){return t.key}function D(t){const e=function(t){let e=(t=t||window.event).target,n=0,s=0;for(;e.offsetParent;)n+=e.offsetLeft,s+=e.offsetTop,e=e.offsetParent;return{x:n,y:s}}(t),n=function(t){return{x:(t=t||window.event).pageX||t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:t.pageY||t.clientY+document.body.scrollTop+document.documentElement.scrollTop}}(t);return{x:n.x-e.x,y:n.y-e.y}}function L(t){const e=document.getElementById("output");e.style.display="block",e.value=t}function B(){const t=g.selectedObject;g.selectedObject=null,Y(y.getContext("2d")),g.selectedObject=t;const e=y.toDataURL("image/png");document.location.href=e}function E(){const t=new A,e=g.selectedObject;g.selectedObject=null,Y(t),g.selectedObject=e,L(t.toSVG())}function R(){const t=new m,e=g.selectedObject;g.selectedObject=null,Y(t),g.selectedObject=e,L(t.toLaTeX())}class ${constructor(t,e){this.nodeA=t,this.nodeB=e,this.text="",this.lineAngleAdjust=0,this.parallelPart=.5,this.perpendicularPart=0}getAnchorPoint(){const t=this.nodeB.x-this.nodeA.x,e=this.nodeB.y-this.nodeA.y,n=Math.sqrt(t*t+e*e);return{x:this.nodeA.x+t*this.parallelPart-e*this.perpendicularPart/n,y:this.nodeA.y+e*this.parallelPart+t*this.perpendicularPart/n}}setAnchorPoint(t,e){const n=this.nodeB.x-this.nodeA.x,s=this.nodeB.y-this.nodeA.y,i=Math.sqrt(n*n+s*s);this.parallelPart=(n*(t-this.nodeA.x)+s*(e-this.nodeA.y))/(i*i),this.perpendicularPart=(n*(e-this.nodeA.y)-s*(t-this.nodeA.x))/i,this.parallelPart>0&&this.parallelPart<1&&Math.abs(this.perpendicularPart)<6&&(this.lineAngleAdjust=+(this.perpendicularPart<0)*Math.PI,this.perpendicularPart=0)}getEndPointsAndCircle(){if(0==this.perpendicularPart){const t=(this.nodeA.x+this.nodeB.x)/2,e=(this.nodeA.y+this.nodeB.y)/2,n=this.nodeA.closestPointOnCircle(t,e),s=this.nodeB.closestPointOnCircle(t,e);return{hasCircle:!1,startX:n.x,startY:n.y,endX:s.x,endY:s.y}}const t=this.getAnchorPoint(),e=function(t,e,n,s,i,a){const o=u(t,e,1,n,s,1,i,a,1),r=-u(t*t+e*e,e,1,n*n+s*s,s,1,i*i+a*a,a,1),l=u(t*t+e*e,t,1,n*n+s*s,n,1,i*i+a*a,i,1),c=-u(t*t+e*e,t,e,n*n+s*s,n,s,i*i+a*a,i,a);return{x:-r/(2*o),y:-l/(2*o),radius:Math.sqrt(r*r+l*l-4*o*c)/(2*Math.abs(o))}}(this.nodeA.x,this.nodeA.y,this.nodeB.x,this.nodeB.y,t.x,t.y),n=this.perpendicularPart>0,s=n?1:-1,i=Math.atan2(this.nodeA.y-e.y,this.nodeA.x-e.x)-30*s/e.radius,a=Math.atan2(this.nodeB.y-e.y,this.nodeB.x-e.x)+30*s/e.radius;return{hasCircle:!0,startX:e.x+e.radius*Math.cos(i),startY:e.y+e.radius*Math.sin(i),endX:e.x+e.radius*Math.cos(a),endY:e.y+e.radius*Math.sin(a),startAngle:i,endAngle:a,circleX:e.x,circleY:e.y,circleRadius:e.radius,reverseScale:s,isReversed:n}}draw(t){const e=this.getEndPointsAndCircle();if(t.beginPath(),e.hasCircle?t.arc(e.circleX,e.circleY,e.circleRadius,e.startAngle,e.endAngle,e.isReversed):(t.moveTo(e.startX,e.startY),t.lineTo(e.endX,e.endY)),t.stroke(),e.hasCircle?O(t,e.endX,e.endY,e.endAngle-e.reverseScale*(Math.PI/2)):O(t,e.endX,e.endY,Math.atan2(e.endY-e.startY,e.endX-e.startX)),e.hasCircle){let n=e.startAngle,s=e.endAngle;s<n&&(s+=2*Math.PI);const i=(n+s)/2+ +e.isReversed*Math.PI,a=e.circleX+e.circleRadius*Math.cos(i),o=e.circleY+e.circleRadius*Math.sin(i);j(t,this.text,a,o,i,g.selectedObject==this)}else{const n=(e.startX+e.endX)/2,s=(e.startY+e.endY)/2,i=Math.atan2(e.endX-e.startX,e.startY-e.endY);j(t,this.text,n,s,i+this.lineAngleAdjust,g.selectedObject==this)}}containsPoint(t,e){const n=this.getEndPointsAndCircle();if(!n.hasCircle){const s=n.endX-n.startX,i=n.endY-n.startY,a=Math.sqrt(s*s+i*i),o=(s*(t-n.startX)+i*(e-n.startY))/(a*a),r=(s*(e-n.startY)-i*(t-n.startX))/a;return o>0&&o<1&&Math.abs(r)<6}{const s=t-n.circleX,i=e-n.circleY,a=Math.sqrt(s*s+i*i)-n.circleRadius;if(Math.abs(a)<6){let t=Math.atan2(i,s),e=n.startAngle,a=n.endAngle;if(n.isReversed){const t=e;e=a,a=t}return a<e&&(a+=2*Math.PI),t<e?t+=2*Math.PI:t>a&&(t-=2*Math.PI),t>e&&t<a}}return!1}}function N(t,e){for(const n of e.values())t.add(n)}function q(t){return t instanceof M?`${t.text}:${t.x},${t.y}`:t instanceof $?`${q(t.nodeA)}->${q(t.nodeB)}:${t.text}${t.getAnchorPoint().x},${t.getAnchorPoint().y}`:t instanceof _?`${q(t.node)}:${t.getStartPoint().x},${t.getStartPoint().y}`:JSON.stringify(t)}function G(){return{x:Math.random()*(y.width-60)+30,y:Math.random()*(y.height-60)+30}}function W(t,e,n){if(t.isAcceptState)return;const s=[],i=[],a=[],o=[];for(let e=0;e<n.length;e++){const o=n[e];if(o instanceof b&&o.node==t)a.push(o);else if(o instanceof $)o.nodeA==t?i.push(o):o.nodeB==t&&s.push(o);else if(o instanceof _&&o.node==t)return}let r="";if(a.length>0){const t=[];for(let e=0;e<a.length;e++)t.push(...a[e].text.split(","));1==t.length&&1==t[0].length?r=`${t[0]}*`:t.length>0&&(r=`(${t.join("+")})*`)}for(let t=0;t<s.length;t++){const e=s[t];for(let t=0;t<i.length;t++){const s=i[t];let a,o;o=`${F(e.text.split(",").map((t=>t.trim())).join("+"))}${r}${F(s.text.split(",").map((t=>t.trim())).join("+"))}`,a=e.nodeA==s.nodeB?new b(e.nodeA):new $(e.nodeA,s.nodeB),o=z(o.replace(new RegExp("/([)*w])(\\epsilon)/g"),"$1").replace(new RegExp("/(\\epsilon)([(w])/g"),"$2")),a.text=o,n.push(a)}}let l=n.length;for(;l--;)(s.some((t=>t==n[l]))||i.some((t=>t==n[l]))||a.some((t=>t==n[l])))&&n.splice(l,1);e.splice(e.indexOf(t),1);for(let t=0;t<o.length;t++)n.push(o[t]);!function(t){const e=[],n=new Map;for(let e=0;e<t.length;e++){const s=t[e];if(s instanceof b)continue;if(!(s instanceof $))continue;let i=q(s.nodeA)+q(s.nodeB);n.get(i)?n.get(i).push(s):n.set(i,[s])}for(const t of n.values())if(t.length>1){t[0].text=`${t.map((t=>t.text)).join("+")}`;for(let n=1;n<t.length;n++)e.push(t[n])}let s=t.length;for(;s--;)e.some((e=>e==t[s]))&&t.splice(s,1)}(n)}function F(d){if(d.includes("+")){let u=function(n){const d=function(n){n=w(n=n.replace(/(\w)\*/g,"($1)*"));const o=[];let r=0,h=0;for(;h<n.length;){if(a.includes(n[h]))r!=h&&o.push(n.slice(r,h)),r=h+1,o.push(n[h]);else if(n[h]==e){let t=o.length-1,e=0;for(;t>=0&&(o[t]==i?e++:o[t]==s&&e--,0!=e);)t--;o.splice(t,0,n[h]),r=h+1}h++}for(r!=h&&o.push(n.slice(r)),h=o.length-1;h>0;)l.includes(o[h-1])||c.includes(o[h])||o.splice(h,0,t),h--;return o}(n),u=[],f=[];for(let t=0;t<d.length;t++){const n=d[t];if(n==e)f.push(n);else if(o.includes(n)){for(;f.length>0;){let t=f[f.length-1];if(!(t!=s&&h[t]>=h[n]))break;u.push(f.pop())}f.push(n)}else if(n==s)f.push(n);else if(n==i){for(;f.length>0&&f[f.length-1]!=s;)u.push(f.pop());0==f.length&&console.error("The operator stack is empty, fix the parentheses."),f.pop(),f.length>0&&r.includes(f[length-1])&&u.push(f.pop())}else u.push(n)}for(;f.length>0;)u.push(f.pop());return u}(d);if(u.length>0&&u[u.length-1]==n){if(d.charAt(0)!=s||d.charAt(d.length-1)!=i)return`(${d})`;{let t=0;for(let e=1;e<d.length-1;e++)if(d[e]==s?t++:d[e]==i&&t--,t<0)return`(${d})`;if(0!=t)return console.warn(`String "${d}" has non matching number of parentheses.`),d}}}return d}function z(t){if(t.length>2&&t.charAt(0)==s&&t.charAt(t.length-1)==i){let e=0;for(let n=1;n<t.length-1;n++)if(t[n]==s?e++:t[n]==i&&e--,e<0)return t;return 0!=e?t:t.substring(1,t.length-1)}return t}class V{constructor(t,e){this.from=t,this.to=e}draw(t){t.beginPath(),t.moveTo(this.to.x,this.to.y),t.lineTo(this.from.x,this.from.y),t.stroke(),O(t,this.to.x,this.to.y,Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x))}}class J{constructor(){this.#t()}#t(){this.state_names=[],this.transitions=new Map,this.starting_state=-1,this.accepting_states=new Set}load(t,e){this.#t();const n=new Map;let s=0;for(let e=0;e<t.length;e++){const i=t[e];n.set(q(i),s),this.state_names.push(i.text),i.isAcceptState&&this.accepting_states.add(s),s++}for(let t=0;t<e.length;t++){const s=e[t];if(s instanceof $){const t=n.get(q(s.nodeA)),e=n.get(q(s.nodeB)),i=s.text.split(",").map((t=>t.trim()));this.transitions.has(t)||this.transitions.set(t,new Map);for(const n of i)this.transitions.get(t).has(n)||this.transitions.get(t).set(n,new Set),this.transitions.get(t).get(n).add(e)}else if(s instanceof b){const t=n.get(q(s.node)),e=t,i=s.text.split(",").map((t=>t.trim()));this.transitions.has(t)||this.transitions.set(t,new Map);for(const n of i)this.transitions.get(t).has(n)||this.transitions.get(t).set(n,new Set),this.transitions.get(t).get(n).add(e)}else s instanceof _&&(this.starting_state=n.get(q(s.node)))}}create_elements(){const t=[],e=[],n=new Map;for(let e=0;e<this.state_names.length;e++){const s=G(),i=new M(s.x,s.y);i.text=this.state_names[e],n.set(e,i),this.accepting_states.has(e)&&(i.isAcceptState=!0),t.push(i)}for(const[t,s]of this.transitions.entries())for(const[i,a]of s.entries())for(const s of a.values()){let a;t==s?a=new b(n.get(t)):(G(),a=new $(n.get(t),n.get(s)),a.perpendicularPart+=100*Math.random()),a.text=i,e.push(a)}if(-1!=this.starting_state){const t=new _(n.get(this.starting_state)),s=G();t.setAnchorPoint(s.x,s.y),t.text="start",e.push(t)}return{nodes:t,links:e}}add_transitions(t,e,n){this.transitions.has(t)||this.transitions.set(t,new Map),this.transitions.get(t).has(e)||this.transitions.get(t).set(e,new Set),N(this.transitions.get(t).get(e),n)}add_transition(t,e,n){this.transitions.has(t)||this.transitions.set(t,new Map),this.transitions.get(t).has(e)||this.transitions.get(t).set(e,new Set),this.transitions.get(t).get(e).add(n)}deep_delta(t,e){const n=new Set;for(const s of this.get_equivalents(t).values())N(n,this.shallow_delta(s,e));return this.get_equivalents(n)}shallow_delta(t,e){return this.transitions.has(t)&&this.transitions.get(t).has(e)?new Set(this.transitions.get(t).get(e)):new Set}get_equivalents(t){t=t instanceof Set?new Set(t):new Set([t]);const e=Array.from(t);for(;e.length>0;){let n=this.shallow_delta(e.pop(),d);for(const s of n.values())t.has(s)||(e.push(s),t.add(s))}return t}is_deterministic(){for(const t of this.transitions.values())for(const[e,n]of t.entries())if(e==d||n.size>1)return!1;return!0}}function U(t){const e=Array.from(t);return e.sort(),e.join(",")}window.onload=function(){var t;t=document.getElementById("canvas"),y=t,function(){if(localStorage&&JSON)try{const t=JSON.parse(localStorage.fsm);for(let e=0;e<t.nodes.length;e++){const n=t.nodes[e],s=new M(n.x,n.y);s.isAcceptState=n.isAcceptState,s.text=n.text,p.push(s)}for(let e=0;e<t.links.length;e++){const n=t.links[e];let s=null;"SelfLink"==n.type?(s=new b(p[n.node]),s.anchorAngle=n.anchorAngle,s.text=n.text):"StartLink"==n.type?(s=new _(p[n.node]),s.deltaX=n.deltaX,s.deltaY=n.deltaY,s.text=n.text):"Link"==n.type&&(s=new $(p[n.nodeA],p[n.nodeB]),s.parallelPart=n.parallelPart,s.perpendicularPart=n.perpendicularPart,s.text=n.text,s.lineAngleAdjust=n.lineAngleAdjust),null!=s&&x.push(s)}}catch(t){localStorage.fsm=""}}(),T(),document.getElementById("a-saveAsPNG").onclick=B,document.getElementById("a-saveAsSVG").onclick=E,document.getElementById("a-saveAsLaTeX").onclick=R,y.onmousedown=function(t){const e=D(t);return g.selectedObject=C(e.x,e.y),g.movingObject=!1,g.originalClick=e,null!=g.selectedObject?(K&&g.selectedObject instanceof M?g.currentLink=new b(g.selectedObject,e):(g.movingObject=!0,"setMouseStart"in g.selectedObject&&g.selectedObject.setMouseStart(e.x,e.y)),X()):K&&(g.currentLink=new V(e,e)),T(),!v()&&(X(),!0)},y.ondblclick=function(t){const e=D(t);g.selectedObject=C(e.x,e.y),null==g.selectedObject?(g.selectedObject=new M(e.x,e.y),p.push(g.selectedObject),X(),T()):g.selectedObject instanceof M&&(g.selectedObject.isAcceptState=!g.selectedObject.isAcceptState,T())},y.onmousemove=function(t){const e=D(t);if(null!=g.currentLink){let t=C(e.x,e.y);t instanceof M||(t=null),null==g.selectedObject?g.currentLink=null!=t?new _(t,g.originalClick):new V(g.originalClick,e):t==g.selectedObject?g.currentLink=new b(g.selectedObject,e):g.currentLink=null!=t?new $(g.selectedObject,t):new V(g.selectedObject.closestPointOnCircle(e.x,e.y),e),T()}g.movingObject&&(g.selectedObject.setAnchorPoint(e.x,e.y),g.selectedObject instanceof M&&function(t){for(let e=0;e<p.length;e++)p[e]!=t&&(Math.abs(t.x-p[e].x)<6&&(t.x=p[e].x),Math.abs(t.y-p[e].y)<6&&(t.y=p[e].y))}(g.selectedObject),T())},y.onmouseup=function(t){g.movingObject=!1,null!=g.currentLink&&(g.currentLink instanceof V||(g.selectedObject=g.currentLink,x.push(g.currentLink),X()),g.currentLink=null,T())},y.oncontextmenu=function(t){return function(){const t=new J;if(t.load(p,x),t.is_deterministic())return void console.warn("Tried to perform subset construction on a DFA.");if(-1==t.starting_state)return void console.warn("FA has no starting state so subset construction failed.");const e=function(t){const e=new J,n=new Map,s=[],i=[];let a=0;e.starting_state=0;const o=t.get_equivalents(t.starting_state);n.set(U(o),a);const r=Array.from(o).map((e=>t.state_names[e]));for(r.sort(),s.push(`{${r.join("")}}`),i.push(o),Array.from(o).some((e=>t.accepting_states.has(e)))&&e.accepting_states.add(a),a++;i.length>0;){const o=i.pop(),r=U(o),l=n.get(r),c=new Map;for(const e of o)if(t.transitions.has(e))for(const n of t.transitions.get(e).keys())n!=d&&(c.has(n)||c.set(n,new Set),N(c.get(n),t.deep_delta(e,n)));for(const[o,r]of c.entries()){const c=U(r);if(n.has(c))e.add_transition(l,o,n.get(c));else{const c=U(r);n.set(c,a);const h=Array.from(r).map((e=>t.state_names[e]));h.sort(),s.push(`{${h.join("")}}`),i.push(r),Array.from(r).some((e=>t.accepting_states.has(e)))&&e.accepting_states.add(a),e.add_transition(l,o,a),a++}}}return e.state_names=s,e}(t),{nodes:n,links:s}=e.create_elements();!function(t,e){p.splice(0,p.length),x.splice(0,x.length);for(let e=0;e<t.length;e++)p.push(t[e]);for(let t=0;t<e.length;t++)x.push(e[t])}(n,s)}(),g.selectedObject=null,T(),t.preventDefault(),!1}};let K=!1;document.addEventListener("keydown",(function(t){const e=I(t);if("Shift"==e)K=!0;else{if(!v())return!0;if("Backspace"==e)return null!=g.selectedObject&&"text"in g.selectedObject&&(g.selectedObject.text=g.selectedObject.text.substr(0,g.selectedObject.text.length-1),X(),T()),!1;if("Delete"==e){if(null!=g.selectedObject){for(let t=0;t<p.length;t++)p[t]==g.selectedObject&&p.splice(t--,1);for(let t=0;t<x.length;t++)x[t]!=g.selectedObject&&x[t].node!=g.selectedObject&&x[t].nodeA!=g.selectedObject&&x[t].nodeB!=g.selectedObject||x.splice(t--,1);g.selectedObject=null,T()}}else if("]"==e){if(null!=C)for(let t=0;t<p.length;t++)p[t]==g.selectedObject&&(W(g.selectedObject,p,x),g.selectedObject=null,T())}else if(1==e.length&&e.charCodeAt(0)&&e.charCodeAt(0)&&null!=g.selectedObject&&"text"in g.selectedObject)return g.selectedObject.text+=e,X(),T(),t.preventDefault(),!1}})),document.addEventListener("keyup",(function(t){"Shift"==I(t)&&(K=!1)}))})();